<!DOCTYPE html>
<html lang="pt-pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lista de Compras 4.2 (Login An칩nimo)</title>
    
    <!-- Configura칞칚o do Firebase Injetada -->
    <script type="module">
        const firebaseConfig = {
            apiKey: "AIzaSyBzaa9oat9DLxXBQs0VRa17VSKXk7y_Yko",
            authDomain: "listadecompras-e6a90.firebaseapp.com",
            projectId: "listadecompras-e6a90",
            storageBucket: "listadecompras-e6a90.firebasestorage.app",
            messagingSenderId: "259432208605",
            appId: "1:259432208605:web:9e62e74ab7bb3be5dfe334"
        };
        
        // Simula칞칚o das vari치veis globais para o ambiente de execu칞칚o
        window.__firebase_config = JSON.stringify(firebaseConfig);
        window.__app_id = firebaseConfig.projectId;
        // Se estiver fora do Canvas, __initial_auth_token n칚o existir치, e o app usar치 signInAnonymously()
        window.__initial_auth_token = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : undefined;
    </script>

    <!-- Importa칞칫es do Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            signInAnonymously, // Voltamos ao Login An칩nimo
            signInWithCustomToken, // Necess치rio para o Canvas
            onAuthStateChanged 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            setDoc, 
            onSnapshot, 
            collection, 
            query, 
            deleteDoc,
            getDoc,
            getDocs 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // Atribui as importa칞칫es a `window` para que o script principal possa aceder a elas
        window.firebaseDependencies = {
            initializeApp, getAuth, signInAnonymously, signInWithCustomToken,
            onAuthStateChanged, getFirestore, doc, setDoc, 
            onSnapshot, collection, query, deleteDoc, getDoc, getDocs, setLogLevel
        };
    </script>
    
    <style>
        /* Estilos CSS adaptados para dispositivos m칩veis */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #eef2f5;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
            padding: 20px 10px;
            margin: 0;
        }

        .container {
            background-color: #ffffff;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 450px;
            box-sizing: border-box;
        }

        h1 {
            text-align: center;
            color: #1e3a8a;
            margin-bottom: 20px;
            font-size: 1.8em;
        }

        /* 츼rea de Autentica칞칚o */
        #auth-status {
            text-align: center;
            margin-bottom: 20px;
        }

        #user-info {
            font-size: 0.9em;
            color: #4b5563;
            margin-top: 5px;
            word-wrap: break-word;
        }
        
        .error-message {
            color: #dc2626;
            background-color: #fee2e2;
            padding: 10px;
            border-radius: 6px;
            margin-top: 10px;
            font-size: 0.9em;
            text-align: left;
        }
        
        .alert-message {
             color: #1e3a8a;
            background-color: #e0f2fe;
            padding: 10px;
            border-radius: 6px;
            margin-top: 10px;
            font-size: 0.9em;
            text-align: left;
        }


        /* Formul치rio de Adi칞칚o */
        #form-item {
            display: grid;
            grid-template-columns: 1fr 100px; /* Item/Pre칞o/Qtd/Categoria + Bot칚o */
            gap: 10px;
            margin-bottom: 20px;
            border-top: 1px solid #f3f4f6;
            padding-top: 15px;
        }

        .input-group {
            display: flex;
            gap: 5px;
            grid-column: 1 / 3; /* Ocupa as duas colunas */
            margin-bottom: 10px;
            flex-wrap: wrap;
        }
        
        .input-item-wrap {
            flex-basis: 100%;
            display: flex;
            gap: 5px;
        }

        #input-item, #input-preco, #input-quantity, #input-categoria {
            padding: 10px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 1em;
            box-sizing: border-box;
        }
        
        #input-item {
            flex-grow: 3;
            width: 100%;
        }
        #input-preco, #input-quantity {
            flex-grow: 1;
            width: auto;
            max-width: 70px;
            text-align: center;
        }
        #input-categoria {
            flex-grow: 1;
        }

        #form-item button {
            grid-column: 2 / 3; /* Ocupa a segunda coluna (Adicionar) */
            padding: 10px 15px;
            border: none;
            background-color: #10b981;
            color: white;
            cursor: pointer;
            font-size: 1em;
            border-radius: 6px;
            transition: background-color 0.3s;
            height: 40px;
        }

        #form-item button:hover {
            background-color: #059669;
        }

        /* Controlo de Ordena칞칚o */
        #sort-controls {
            display: flex;
            justify-content: flex-end;
            align-items: center;
            margin-bottom: 10px;
            font-size: 0.9em;
            color: #4b5563;
        }
        #sort-select {
            padding: 5px;
            border-radius: 6px;
            border: 1px solid #d1d5db;
            margin-left: 5px;
        }

        /* Lista de Compras */
        #lista-compras {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        
        .category-header {
            background-color: #f3f4f6;
            color: #374151;
            padding: 5px 10px;
            margin-top: 15px;
            margin-bottom: 5px;
            border-radius: 4px;
            font-weight: bold;
            font-size: 0.9em;
            border-left: 5px solid #1e3a8a;
        }

        #lista-compras li {
            display: grid;
            grid-template-columns: 1fr auto auto auto; /* Nome | Qtd | Pre칞o | Remover */
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #e5e7eb;
            font-size: 1em;
            gap: 5px;
        }

        .item-name {
            cursor: pointer;
            transition: color 0.3s;
            word-break: break-word;
        }
        
        .item-comprado {
             opacity: 0.6;
        }

        .item-comprado .item-name {
            text-decoration: line-through;
            color: #9ca3af;
        }

        .editable-price, .editable-quantity {
            font-weight: bold;
            color: #374151;
            text-align: right;
            cursor: pointer;
            padding: 8px 5px; /* Aumenta a 치rea de clique/toque */
            min-width: 50px; 
            border-radius: 4px;
            transition: background-color 0.2s;
        }
        
        .editable-price:hover, .editable-quantity:hover {
            background-color: #f3f4f6;
        }

        .remover-item {
            background-color: #ef4444;
            color: white;
            padding: 5px 8px;
            font-size: 0.8em;
            border-radius: 5px;
            transition: background-color 0.3s;
        }

        .remover-item:hover {
            background-color: #dc2626;
        }

        /* 츼rea de Total */
        .total-area {
            text-align: right;
            margin-top: 15px;
            padding-top: 10px;
            border-top: 2px solid #ccc;
            font-size: 1.2em;
            color: #1e3a8a;
        }

        /* Bot칚o Finalizar Compra */
        #arquivar-btn {
            width: 100%;
            background-color: #f97316; /* Laranja */
            margin-top: 20px;
            border-radius: 6px;
            padding: 12px;
            font-weight: bold;
        }
        #arquivar-btn:hover {
            background-color: #ea580c;
        }
        
        /* Hist칩rico */
        .historico {
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #e5e7eb;
        }

        .historico h2 {
            font-size: 1.4em;
            color: #374151;
            margin-bottom: 15px;
        }

        .historico-lista li {
            background-color: #f9fafb;
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        }

        .historico-header {
            display: flex;
            justify-content: space-between;
            font-weight: bold;
            color: #1e3a8a;
            margin-bottom: 5px;
            border-bottom: 1px dashed #e5e7eb;
            padding-bottom: 5px;
            font-size: 0.95em;
        }

        .historico-detalhe {
            font-size: 0.9em;
            color: #4b5563;
            margin-left: 10px;
        }

        .item-detalhe {
            display: block;
            margin-top: 3px;
            margin-left: 5px;
        }

        .loading-message {
            text-align: center;
            padding: 20px;
            color: #6b7280;
        }
        
        .disabled-overlay {
            opacity: 0.4;
            pointer-events: none;
            filter: blur(2px);
            transition: opacity 0.5s;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>游 Minha Lista de Compras</h1>
        
        <div id="auth-status">
            <div id="user-info">A carregar autentica칞칚o...</div>
             <div id="auth-error-message" class="error-message" style="display:none;"></div>
             <div class="alert-message">
                <strong>Modo Nuvem (Firebase Ativo):</strong> A sua lista est치 a ser salva automaticamente na nuvem usando **Login An칩nimo**.
                <br><em>Aten칞칚o: Ative o provedor An칩nimo no seu console do Firebase!</em>
             </div>
        </div>

        <div id="app-content" class="loading-message disabled-overlay">
            <p id="loading-text">Aguardando conex칚o segura...</p>
            
            <!-- Controlo de Ordena칞칚o -->
            <div id="sort-controls">
                <span>Ordenar por:</span>
                <select id="sort-select">
                    <option value="adicao">Ordem de Inclus칚o</option>
                    <option value="categoria">Categoria (Corredor)</option>
                </select>
            </div>

            <!-- Formul치rio de Adi칞칚o -->
            <form id="form-item">
                <div class="input-group">
                    <div class="input-item-wrap">
                        <input type="text" id="input-item" placeholder="Item (Ex: Arroz)" required list="catalog-suggestions">
                    </div>
                    <input type="number" id="input-quantity" placeholder="Qtd" value="1" min="1">
                    <input type="number" id="input-preco" placeholder="Pre칞o" step="0.01" min="0">
                    <select id="input-categoria">
                        <option value="">-- Categoria --</option>
                    </select>
                </div>
                <button type="submit">Adicionar</button>
            </form>

            <datalist id="catalog-suggestions"></datalist>
            
            <ul id="lista-compras">
                <!-- Itens ativos ser칚o adicionados aqui -->
            </ul>
            
            <div class="total-area">
                <strong>Total Atual:</strong> <span id="valor-total">R$ 0,00</span>
            </div>

            <button id="arquivar-btn">Finalizar Compra e Arquivar</button>
        
            <div class="historico">
                <h2>Hist칩rico de Compras</h2>
                <ul class="historico-lista" id="historico-compras">
                    <!-- Hist칩rico ser치 adicionado aqui -->
                </ul>
            </div>
        </div>
    </div>

    <!-- Script Principal com toda a l칩gica -->
    <script type="module">
        // Importa as depend칡ncias do Firebase carregadas na janela
        const { 
            initializeApp, getAuth, signInAnonymously, signInWithCustomToken,
            onAuthStateChanged, getFirestore, doc, setDoc, onSnapshot, collection, 
            query, deleteDoc, getDoc, getDocs, setLogLevel
        } = window.firebaseDependencies;
        
        // --- CONSTANTES E VARI츼VEIS GLOBAIS ---
        const LOCAL_STORAGE_KEY_LISTA = 'shoppingList';
        const LOCAL_STORAGE_KEY_ARQUIVO = 'shoppingArchive';
        const LOCAL_STORAGE_KEY_CATALOGO = 'shoppingCatalog';

        let db, auth, userId = null;
        let listaAtivaRef, historicoRef, catalogoRef;
        let totalAtual = 0;
        let listaCache = []; // Cache local da lista para ordena칞칚o
        
        const catalogData = {}; // Cat치logo persistente em mem칩ria (usu치rio + padr칚o)
        
        const appContent = document.getElementById('app-content');
        const loadingText = document.getElementById('loading-text');
        
        const userInfoDiv = document.getElementById('user-info');
        const authErrorMessageDiv = document.getElementById('auth-error-message');

        const form = document.getElementById('form-item');
        const inputItem = document.getElementById('input-item');
        const inputPreco = document.getElementById('input-preco');
        const inputQuantity = document.getElementById('input-quantity');
        const inputCategoria = document.getElementById('input-categoria');
        const listaUL = document.getElementById('lista-compras');
        const arquivarBtn = document.getElementById('arquivar-btn');
        const valorTotalSpan = document.getElementById('valor-total');
        const historicoUL = document.getElementById('historico-compras');
        const datalist = document.getElementById('catalog-suggestions');
        const sortSelect = document.getElementById('sort-select');
        
        // --- LISTA DE CATEGORIAS ---
        const CATEGORIAS = [
            { id: "A01", nome: "Hortifr칰ti / Frios" },
            { id: "A02", nome: "Latic칤nios / Iogurtes" },
            { id: "B01", nome: "Padaria / Matinais" },
            { id: "C01", nome: "Carnes / Peixes Congelados" },
            { id: "D01", nome: "Mercearia (Arroz, Feij칚o)" },
            { id: "D02", nome: "Bebidas / Sucos" },
            { id: "E01", nome: "Limpeza" },
            { id: "E02", nome: "Higiene Pessoal" },
            { id: "Z99", nome: "Outros" }
        ];
        
        // Preenche o Select de Categorias
        function populateCategorias() {
            CATEGORIAS.forEach(cat => {
                const option = document.createElement('option');
                option.value = cat.id;
                option.textContent = cat.nome;
                inputCategoria.appendChild(option);
            });
        }
        populateCategorias();
        
        // --- PRODUTOS INICIAIS (Cat치logo Padr칚o) ---
        // Adiciona a categoria aos produtos padr칚o
        const PRODUTOS_PADRAO = [
            { nome: "Arroz (5kg)", preco: 25.50, categoria: "D01" }, 
            { nome: "Feij칚o Preto (1kg)", preco: 7.80, categoria: "D01" },
            { nome: "Leite Integral (1L)", preco: 5.20, categoria: "A02" }, 
            { nome: "Caf칠 (500g)", preco: 18.90, categoria: "B01" },
            { nome: "P칚o de Forma", preco: 8.50, categoria: "B01" }, 
            { nome: "Ovos (d칰zia)", preco: 15.00, categoria: "A02" },
            { nome: "Azeite (500ml)", preco: 32.00, categoria: "D01" }, 
            { nome: "Frango (1kg)", preco: 16.50, categoria: "C01" },
            { nome: "Ma칞칚 (kg)", preco: 8.00, categoria: "A01" }, 
            { nome: "Banana (kg)", preco: 6.50, categoria: "A01" },
            { nome: "Detergente", preco: 3.50, categoria: "E01" }, 
            { nome: "Papel Higi칠nico (12uni)", preco: 20.00, categoria: "E02" }
        ];

        // --- FUN칂칏ES DE PERSIST칅NCIA (Firestore/Local) ---

        const getStoreRefs = (id) => {
            const appId = typeof window.__app_id !== 'undefined' ? window.__app_id : 'default-app-id';
            // Padr칚o de seguran칞a: /artifacts/{appId}/users/{userId}
            const userRoot = `/artifacts/${appId}/users/${id}`;
            listaAtivaRef = collection(db, `${userRoot}/listas/ativa`);
            historicoRef = collection(db, `${userRoot}/listas/arquivo`);
            catalogoRef = doc(db, `${userRoot}/catalogo/precos`);
        }

        const loadFromLocal = (key) => {
            try {
                const data = localStorage.getItem(key);
                return data ? JSON.parse(data) : null;
            } catch (e) {
                console.error("Erro ao carregar do Local Storage:", e);
                return null;
            }
        };

        const saveToLocal = (key, data) => {
            try {
                localStorage.setItem(key, JSON.stringify(data));
            } catch (e) {
                console.error("Erro ao salvar no Local Storage:", e);
            }
        };
        
        // Fun칞칚o unificada de Load para Firestore ou LocalStorage
        async function loadInitialData(isFirestore) {
            listaUL.innerHTML = '';
            historicoUL.innerHTML = '';
            
            if (isFirestore) {
                // 1. Carregar Cat치logo
                const catalogSnap = await getDoc(catalogoRef);
                const userCatalog = catalogSnap.exists() ? catalogSnap.data().precos : {};
                
                // Mescla cat치logo padr칚o com cat치logo do usu치rio
                PRODUTOS_PADRAO.forEach(p => {
                    catalogData[p.nome] = { preco: p.preco.toFixed(2), categoria: p.categoria };
                });
                Object.assign(catalogData, userCatalog);
                
                // 2. Observar Lista Ativa
                onSnapshot(listaAtivaRef, (snapshot) => {
                    listaCache = [];
                    snapshot.forEach(doc => listaCache.push({ id: doc.id, ...doc.data() }));
                    renderListaAtiva(); // Renderiza a partir do cache
                });

                // 3. Observar Hist칩rico
                onSnapshot(historicoRef, (snapshot) => {
                    const historico = [];
                    snapshot.forEach(doc => historico.push({ id: doc.id, ...doc.data() }));
                    renderHistorico(historico);
                });
            } else {
                // FALLBACK: Local Storage
                const lista = loadFromLocal(LOCAL_STORAGE_KEY_LISTA) || [];
                const historico = loadFromLocal(LOCAL_STORAGE_KEY_ARQUIVO) || [];
                const userCatalog = loadFromLocal(LOCAL_STORAGE_KEY_CATALOGO) || {};
                
                // Mescla cat치logo padr칚o com cat치logo do usu치rio (Local Storage)
                PRODUTOS_PADRAO.forEach(p => {
                    catalogData[p.nome] = { preco: p.preco.toFixed(2), categoria: p.categoria };
                });
                Object.assign(catalogData, userCatalog);
                
                listaCache = lista;
                renderListaAtiva();
                renderHistorico(historico);
            }
             
            // Renderiza o cat치logo e as sugest칫es no datalist
            renderCatalogo();
        }
        
        // Salva o cat치logo persistente (pre칞os e categorias)
        async function saveCatalog() {
            // Filtra apenas os itens que n칚o s칚o do cat치logo padr칚o para salvar
            const userCatalogOnly = {};
            for (const nome in catalogData) {
                if (!PRODUTOS_PADRAO.some(p => p.nome === nome)) {
                    userCatalogOnly[nome] = catalogData[nome];
                }
            }

            if (db && userId) { 
                try {
                    await setDoc(catalogoRef, { precos: userCatalogOnly }, { merge: true });
                } catch(e) {
                    console.error("Erro ao salvar cat치logo no Firestore:", e);
                }
            } else {
                saveToLocal(LOCAL_STORAGE_KEY_CATALOGO, userCatalogOnly);
            }
        }
        
        // --- FUN칂칏ES DE RENDERIZA칂츾O E L칍GICA ---
        
        function formatCurrency(value) {
            return `R$ ${parseFloat(value).toFixed(2).replace('.', ',')}`;
        }

        function updateItemSubtotal(item) {
            return parseFloat(item.preco) * parseInt(item.quantidade);
        }

        function updateTotal() {
            totalAtual = 0;
            listaCache.forEach(item => {
                totalAtual += updateItemSubtotal(item);
            });
            valorTotalSpan.textContent = formatCurrency(totalAtual);
        }

        // Renderiza as sugest칫es do cat치logo
        function renderCatalogo() {
            datalist.innerHTML = '';
            const allProducts = new Set();
            for(const nome in catalogData) {
                allProducts.add(nome);
            }

            allProducts.forEach(nome => {
                const option = document.createElement('option');
                option.value = nome;
                datalist.appendChild(option);
            });
        }
        
        // Persist칡ncia da lista ativa (Firestore ou Local)
        function persistListaAtiva() {
            if (!db) {
                // Local Storage: Salva o array de itens completo
                saveToLocal(LOCAL_STORAGE_KEY_LISTA, listaCache);
                updateTotal();
            }
        }
        
        // Aplica a ordena칞칚o e renderiza a lista no DOM
        function renderListaAtiva() {
            listaUL.innerHTML = '';
            
            // 1. Aplica a ordena칞칚o
            const tipoOrdenacao = sortSelect.value;
            let listaOrdenada = [...listaCache];

            if (tipoOrdenacao === 'categoria') {
                listaOrdenada.sort((a, b) => {
                    const catA = a.categoria || 'Z99';
                    const catB = b.categoria || 'Z99';
                    return catA.localeCompare(catB);
                });
            } else {
                // Ordem de Inclus칚o (timestamp)
                listaOrdenada.sort((a, b) => a.timestamp - b.timestamp);
            }
            
            // 2. Renderiza os itens
            let categoriaAtual = null;

            listaOrdenada.forEach(item => {
                // Se a ordena칞칚o for por categoria, adiciona o cabe칞alho
                if (tipoOrdenacao === 'categoria' && item.categoria !== categoriaAtual) {
                    categoriaAtual = item.categoria;
                    const catNome = CATEGORIAS.find(c => c.id === categoriaAtual)?.nome || "Outros";
                    const header = document.createElement('div');
                    header.className = 'category-header';
                    header.textContent = catNome;
                    listaUL.appendChild(header);
                }
                
                const li = createListItem(item);
                listaUL.appendChild(li);
            });
            
            updateTotal();
            persistListaAtiva();
        }

        // Cria o elemento LI para a lista ativa
        function createListItem(item) {
            const li = document.createElement('li');
            li.setAttribute('data-item', JSON.stringify(item));
            li.setAttribute('data-id', item.id);
            li.setAttribute('data-categoria', item.categoria);
            if (item.comprado) {
                li.classList.add('item-comprado');
            }

            // Encontra o nome da categoria para exibi칞칚o
            const catNome = CATEGORIAS.find(c => c.id === item.categoria)?.nome || 'Outros';

            li.innerHTML = `
                <span class="item-name" title="Categoria: ${catNome}">${item.nome}</span>
                <span class="editable-quantity" contenteditable="true" data-field="quantidade">${item.quantidade}</span>
                <span class="editable-price" contenteditable="true" data-field="preco">${formatCurrency(item.preco)}</span>
                <button class="remover-item">X</button>
            `;

            // 1. Marcar como comprado (clique no nome)
            li.querySelector('.item-name').addEventListener('click', () => toggleComprado(li));

            // 2. Remo칞칚o
            li.querySelector('.remover-item').addEventListener('click', () => removeItem(li));

            // 3. Edi칞칚o de Pre칞o/Quantidade
            li.querySelectorAll('.editable-price, .editable-quantity').forEach(span => {
                span.addEventListener('blur', (e) => handleEdit(li, e));
                span.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        e.target.blur();
                    }
                });
            });

            return li;
        }
        
        // --- FUN칂칏ES DE A칂츾O NA LISTA ---

        async function toggleComprado(li) {
            const itemId = li.getAttribute('data-id');
            const itemIndex = listaCache.findIndex(i => i.id === itemId);
            if (itemIndex === -1) return;

            const item = listaCache[itemIndex];
            item.comprado = !item.comprado;
            
            // Atualiza no Firestore ou Local Storage
            if (db && itemId) {
                try {
                    await setDoc(doc(listaAtivaRef, itemId), { comprado: item.comprado }, { merge: true });
                } catch(e) {
                    console.error("Erro ao atualizar item no Firestore:", e);
                }
            } else {
                renderListaAtiva(); // Re-renderiza para atualizar o visual do local storage
            }
        }

        async function removeItem(li) {
            const itemId = li.getAttribute('data-id');
            
            // Remove do cache
            listaCache = listaCache.filter(i => i.id !== itemId);

            if (db && itemId) {
                try {
                    await deleteDoc(doc(listaAtivaRef, itemId));
                } catch(e) {
                    console.error("Erro ao remover item do Firestore:", e);
                }
            } else {
                renderListaAtiva();
            }
        }
        
        // Lida com a edi칞칚o de pre칞o/quantidade na lista
        async function handleEdit(li, event) {
            const field = event.target.getAttribute('data-field');
            let newValue = event.target.textContent.replace('R$', '').replace(',', '.').trim();
            
            const itemId = li.getAttribute('data-id');
            const itemIndex = listaCache.findIndex(i => i.id === itemId);
            if (itemIndex === -1) return;
            const item = listaCache[itemIndex];

            if (field === 'preco') {
                newValue = Math.max(0, parseFloat(newValue) || 0);
                item.preco = newValue.toFixed(2);
                event.target.textContent = formatCurrency(item.preco);
                
                // Salva o novo pre칞o e categoria no cat치logo persistente
                catalogData[item.nome] = { preco: item.preco, categoria: item.categoria };
                await saveCatalog();

            } else if (field === 'quantidade') {
                newValue = Math.max(1, parseInt(newValue) || 1);
                item.quantidade = newValue;
                event.target.textContent = item.quantidade;
            }

            // Atualiza no Firestore ou Local Storage
            const dataToUpdate = {};
            dataToUpdate[field] = (field === 'preco') ? parseFloat(item.preco) : item.quantidade;
            
            if (db && itemId) {
                try {
                    await setDoc(doc(listaAtivaRef, itemId), dataToUpdate, { merge: true });
                } catch(e) {
                    console.error("Erro ao atualizar item no Firestore:", e);
                }
            } else {
                renderListaAtiva();
            }
        }
        
        // Lida com o envio do formul치rio (Adicionar Item)
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            const nomeItem = inputItem.value.trim();
            const precoItem = parseFloat(inputPreco.value.replace(',', '.')) || 0;
            const quantidadeItem = parseInt(inputQuantity.value) || 1;
            const categoriaItem = inputCategoria.value;

            if (nomeItem) {
                const novoItem = {
                    nome: nomeItem,
                    preco: precoItem.toFixed(2),
                    quantidade: quantidadeItem,
                    categoria: categoriaItem,
                    comprado: false,
                    timestamp: Date.now()
                };
                
                // 1. Salva/Atualiza o pre칞o e categoria no cat치logo persistente
                catalogData[nomeItem] = { preco: novoItem.preco, categoria: novoItem.categoria };
                await saveCatalog();

                // 2. Adiciona  lista ativa (Firestore ou Local Storage)
                if (db) {
                    try {
                        // O Firestore gera o ID e o onSnapshot renderiza
                        const novoDocRef = doc(listaAtivaRef);
                        novoItem.id = novoDocRef.id;
                        await setDoc(novoDocRef, novoItem);
                    } catch(e) {
                        console.error("Erro ao adicionar item ao Firestore:", e);
                    }
                } else {
                    // Local Storage: gera um ID e adiciona ao cache
                    novoItem.id = crypto.randomUUID();
                    listaCache.push(novoItem);
                    renderListaAtiva();
                }

                // Limpa o formul치rio
                inputItem.value = '';
                inputPreco.value = '';
                inputQuantity.value = '1';
                inputCategoria.value = '';
                inputItem.focus();
                
                // Re-renderiza as sugest칫es
                renderCatalogo();
            }
        });
        
        // Lida com o preenchimento autom치tico de pre칞o/categoria
        inputItem.addEventListener('input', () => {
            const nomeItem = inputItem.value.trim();
            const sugestao = catalogData[nomeItem];

            if (sugestao) {
                inputPreco.value = parseFloat(sugestao.preco).toFixed(2);
                inputCategoria.value = sugestao.categoria;
            } else {
                inputPreco.value = '';
                inputCategoria.value = '';
            }
        });

        // Evento para mudar a ordena칞칚o
        sortSelect.addEventListener('change', renderListaAtiva);


        // Arquiva a compra atual
        arquivarBtn.addEventListener('click', async () => {
            if (listaCache.length === 0) {
                console.log("A lista est치 vazia, nada para arquivar.");
                return;
            }

            const itensCompra = listaCache.map(item => {
                return {
                    nome: item.nome,
                    quantidade: item.quantidade,
                    precoUnitario: parseFloat(item.preco),
                    categoria: item.categoria,
                    subtotal: updateItemSubtotal(item)
                };
            });

            const registroArquivo = {
                data: new Date().toISOString(),
                totalGasto: totalAtual,
                itens: itensCompra
            };

            if (db) {
                try {
                    // 1. Adiciona ao Hist칩rico (Firestore)
                    const arquivoRef = doc(historicoRef);
                    await setDoc(arquivoRef, registroArquivo);
                    
                    // 2. Limpa a lista ativa (Firestore)
                    const currentItemsSnapshot = await getDocs(query(listaAtivaRef));
                    const deletePromises = [];
                    currentItemsSnapshot.forEach(doc => {
                        deletePromises.push(deleteDoc(doc.ref));
                    });
                    await Promise.all(deletePromises);
                    
                } catch(e) {
                    console.error("Erro ao arquivar no Firestore:", e);
                }
            } else {
                // Local Storage
                const historico = loadFromLocal(LOCAL_STORAGE_KEY_ARQUIVO) || [];
                historico.unshift(registroArquivo); // Adiciona no in칤cio
                saveToLocal(LOCAL_STORAGE_KEY_ARQUIVO, historico);
                saveToLocal(LOCAL_STORAGE_KEY_LISTA, []); // Limpa lista ativa
                
                listaCache = []; // Limpa cache
                renderHistorico(historico);
                renderListaAtiva(); // Renderiza vazia
            }
        });

        // Renderiza o hist칩rico arquivado
        function renderHistorico(historico) {
            historicoUL.innerHTML = '';
            historico.sort((a, b) => new Date(b.data) - new Date(a.data));

            historico.forEach(registro => {
                const li = document.createElement('li');
                const dataFormatada = new Date(registro.data).toLocaleDateString('pt-pt');

                li.innerHTML = `
                    <div class="historico-header">
                        <span>${dataFormatada}</span>
                        <span>Total: ${formatCurrency(registro.totalGasto)}</span>
                    </div>
                    ${registro.itens.map(item => `
                        <span class="historico-detalhe">
                            ${item.nome} (${item.quantidade} uni) - ${CATEGORIAS.find(c => c.id === item.categoria)?.nome || 'Outros'}
                            <span style="float: right;">${formatCurrency(item.subtotal)}</span>
                        </span>
                    `).join('')}
                `;
                historicoUL.appendChild(li);
            });
        }
        
        // --- FUN칂칏ES DE AUTENTICA칂츾O ---
        
        async function initializeFirebase() {
            try {
                const firebaseConfig = JSON.parse(window.__firebase_config);
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                setLogLevel('debug');
                
                // MUDAN칂A: Login An칩nimo (N칚o precisamos mais de onAuthStateChanged complexo)
                const customToken = window.__initial_auth_token;
                
                if (customToken) {
                    // 1. Login com Custom Token (Ambiente Canvas)
                    await signInWithCustomToken(auth, customToken);
                } else {
                    // 2. Login An칩nimo (GitHub Pages e produ칞칚o)
                    await signInAnonymously(auth);
                }
                
                // Sucesso na Autentica칞칚o An칩nima
                const user = auth.currentUser;
                userId = user.uid;
                getStoreRefs(userId);
                
                userInfoDiv.innerHTML = `Logado anonimamente. ID: ${userId.substring(0, 8)}...`;
                authErrorMessageDiv.style.display = 'none';

                // Habilita o CONTE칔DO
                appContent.classList.remove('disabled-overlay');
                loadingText.style.display = 'none';

                loadInitialData(true); 

            } catch (error) {
                console.error("[CONSOLE_ERROR] Erro fatal do Firebase:", error);
                
                // Trata o erro de Auth/Configura칞칚o
                if (error.code === 'auth/configuration-not-found' || error.code === 'auth/operation-not-allowed') {
                    authErrorMessageDiv.innerHTML = `<strong>Erro de Configura칞칚o!</strong> Por favor, ative o m칠todo 'An칩nimo' no seu console do Firebase.`;
                    authErrorMessageDiv.style.display = 'block';
                }

                // FALLBACK: Se o Firebase falhar, usa Local Storage
                userId = null;
                appContent.classList.remove('disabled-overlay');
                loadingText.textContent = 'ERRO DE NUVEM! A lista ser치 salva apenas neste navegador (Local Storage).';
                loadingText.style.display = 'block';
                userInfoDiv.textContent = 'Modo Offline Ativo.';
                loadInitialData(false);
            }
        }
        
        // Inicia a aplica칞칚o ap칩s o carregamento da janela
        window.addEventListener('load', initializeFirebase);

    </script>
</body>
</html>
