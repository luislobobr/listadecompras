<!DOCTYPE html>
<html lang="pt-pt">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lista de Compras</title>

    <!-- PWA Meta Tags -->
    <meta name="description" content="Aplicativo de lista de compras com sincroniza√ß√£o na nuvem">
    <meta name="theme-color" content="#1e3a8a">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Compras">

    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">

    <!-- Icons -->
    <link rel="icon" type="image/png" sizes="192x192" href="icons/icon-192.png">
    <link rel="apple-touch-icon" href="icons/icon-192.png">

    <style>
        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background-color: #eef2f5;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
            padding: 15px 10px;
            margin: 0;
            font-size: 16px;
            line-height: 1.5;
        }

        .container {
            background-color: #ffffff;
            padding: 20px 15px;
            border-radius: 15px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 500px;
        }

        h1 {
            text-align: center;
            color: #1e3a8a;
            margin-bottom: 25px;
            font-size: 1.8em;
            font-weight: 700;
        }

        #auth-status {
            text-align: center;
            margin-bottom: 25px;
        }

        #user-info {
            font-size: 1em;
            color: #4b5563;
            margin-top: 8px;
            word-wrap: break-word;
            line-height: 1.6;
        }

        .error-message {
            color: #dc2626;
            background-color: #fee2e2;
            padding: 15px;
            border-radius: 8px;
            margin-top: 12px;
            font-size: 0.95em;
            text-align: left;
            line-height: 1.5;
        }

        .alert-message {
            color: #1e3a8a;
            background-color: #e0f2fe;
            padding: 15px;
            border-radius: 8px;
            margin-top: 12px;
            font-size: 0.95em;
            text-align: left;
            line-height: 1.5;
        }

        .success-message {
            color: #065f46;
            background-color: #d1fae5;
            padding: 15px;
            border-radius: 8px;
            margin-top: 12px;
            font-size: 0.95em;
            text-align: left;
            line-height: 1.5;
        }

        #google-login-btn {
            background-color: #4285F4;
            color: white;
            border: none;
            padding: 16px 24px;
            border-radius: 10px;
            font-size: 1.1em;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            margin: 15px auto;
            width: 100%;
            max-width: 280px;
            transition: background-color 0.3s;
            min-height: 56px;
        }

        #google-login-btn:hover {
            background-color: #3367D6;
        }

        #logout-btn {
            background-color: #f97316;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            font-size: 1em;
            cursor: pointer;
            margin-left: 12px;
            transition: background-color 0.3s;
            min-height: 44px;
        }

        #logout-btn:hover {
            background-color: #ea580c;
        }

        .controles-superiores {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .modos-compra {
            display: flex;
            gap: 8px;
            background: #f8fafc;
            padding: 8px;
            border-radius: 12px;
        }

        .modo-btn {
            padding: 12px 16px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.95em;
            transition: all 0.3s;
            background: transparent;
            min-height: 44px;
        }

        .modo-btn.active {
            background: #3b82f6;
            color: white;
        }

        .controle-orcamento {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1em;
        }

        #orcamento-input {
            width: 100px;
            padding: 10px;
            border: 2px solid #d1d5db;
            border-radius: 8px;
            font-size: 1em;
        }

        .status-orcamento {
            padding: 8px 12px;
            border-radius: 15px;
            font-size: 0.9em;
            font-weight: bold;
            min-width: 60px;
            text-align: center;
        }

        .status-dentro {
            background: #dcfce7;
            color: #166534;
        }

        .status-alerta {
            background: #fef3c7;
            color: #92400e;
        }

        .status-excedido {
            background: #fee2e2;
            color: #dc2626;
        }

        .abas-listas {
            display: flex;
            margin-bottom: 20px;
            background: #f8fafc;
            border-radius: 12px;
            padding: 6px;
        }

        .aba {
            flex: 1;
            padding: 15px 10px;
            text-align: center;
            cursor: pointer;
            border-radius: 10px;
            transition: all 0.3s;
            font-weight: 600;
            font-size: 1em;
            min-height: 54px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .aba.active {
            background: white;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .aba-rapida.active {
            border-left: 4px solid #10b981;
        }

        .aba-mercado.active {
            border-left: 4px solid #3b82f6;
        }

        .conteudo-lista {
            display: none;
        }

        .conteudo-lista.active {
            display: block;
        }

        .info-lista {
            font-size: 1em;
            color: #6b7280;
            margin-bottom: 20px;
            padding: 15px;
            background: #f8fafc;
            border-radius: 10px;
            line-height: 1.5;
        }

        #form-item-rapida,
        #form-item-mercado {
            display: grid;
            grid-template-columns: 1fr auto;
            gap: 12px;
            margin-bottom: 25px;
            border-top: 1px solid #f3f4f6;
            padding-top: 20px;
        }

        .input-group {
            display: flex;
            gap: 8px;
            grid-column: 1 / 3;
            margin-bottom: 12px;
            flex-wrap: wrap;
        }

        .input-item-wrap {
            flex-basis: 100%;
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        #input-item-rapida,
        #input-preco-rapida,
        #input-quantity-rapida,
        #input-categoria-rapida,
        #input-item-mercado,
        #input-preco-mercado,
        #input-quantity-mercado,
        #input-categoria-mercado {
            padding: 14px;
            border: 2px solid #d1d5db;
            border-radius: 10px;
            font-size: 1.1em;
            min-height: 52px;
        }

        #input-item-rapida,
        #input-item-mercado {
            flex-grow: 3;
            width: 100%;
        }

        #input-preco-rapida,
        #input-quantity-rapida,
        #input-preco-mercado,
        #input-quantity-mercado {
            flex-grow: 1;
            min-width: 80px;
            text-align: center;
        }

        #input-categoria-rapida,
        #input-categoria-mercado {
            flex-grow: 1;
            min-width: 140px;
        }

        #form-item-rapida button,
        #form-item-mercado button {
            grid-column: 2 / 3;
            padding: 14px 20px;
            border: none;
            background-color: #10b981;
            color: white;
            cursor: pointer;
            font-size: 1.1em;
            border-radius: 10px;
            transition: background-color 0.3s;
            min-height: 52px;
            font-weight: 600;
        }

        #form-item-rapida button:hover,
        #form-item-mercado button:hover {
            background-color: #059669;
        }

        .favoritos-area {
            margin-bottom: 20px;
            padding: 15px;
            background: #fff7ed;
            border-radius: 12px;
            border: 2px dashed #fdba74;
        }

        .favoritos-titulo {
            font-size: 1em;
            font-weight: bold;
            color: #ea580c;
            margin-bottom: 12px;
        }

        .lista-favoritos {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .favorito-btn {
            padding: 10px 16px;
            background: white;
            border: 2px solid #fdba74;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.95em;
            transition: all 0.3s;
            min-height: 44px;
        }

        .favorito-btn:hover {
            background: #ffedd5;
        }

        .sort-controls {
            display: flex;
            justify-content: flex-end;
            align-items: center;
            margin-bottom: 15px;
            font-size: 1em;
            color: #4b5563;
        }

        #sort-select-rapida,
        #sort-select-mercado {
            padding: 10px;
            border-radius: 8px;
            border: 2px solid #d1d5db;
            margin-left: 8px;
            font-size: 1em;
            min-height: 44px;
        }

        .lista-compras {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .category-header {
            background-color: #f3f4f6;
            color: #374151;
            padding: 12px 15px;
            margin-top: 20px;
            margin-bottom: 8px;
            border-radius: 8px;
            font-weight: bold;
            font-size: 1em;
            border-left: 5px solid #1e3a8a;
        }

        .lista-compras li {
            display: grid;
            grid-template-columns: 1fr auto auto auto;
            align-items: center;
            padding: 15px 0;
            border-bottom: 2px solid #e5e7eb;
            font-size: 1.1em;
            gap: 10px;
            min-height: 60px;
        }

        .item-name {
            cursor: pointer;
            transition: color 0.3s;
            word-break: break-word;
            font-size: 1.1em;
            padding: 8px 0;
            line-height: 1.4;
        }

        .item-comprado {
            opacity: 0.6;
        }

        .item-comprado .item-name {
            text-decoration: line-through;
            color: #9ca3af;
        }

        .editable-price,
        .editable-quantity {
            font-weight: bold;
            color: #374151;
            text-align: right;
            cursor: pointer;
            padding: 12px 8px;
            min-width: 70px;
            border-radius: 6px;
            transition: background-color 0.2s;
            font-size: 1.1em;
            border: 1px solid transparent;
        }

        .editable-price:hover,
        .editable-quantity:hover {
            background-color: #f3f4f6;
            border-color: #d1d5db;
        }

        .remover-item {
            background-color: #ef4444;
            color: white;
            padding: 10px 14px;
            font-size: 1em;
            border-radius: 8px;
            transition: background-color 0.3s;
            border: none;
            cursor: pointer;
            min-width: 44px;
            min-height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .remover-item:hover {
            background-color: #dc2626;
        }

        .total-area {
            text-align: right;
            margin-top: 20px;
            padding-top: 15px;
            border-top: 3px solid #ccc;
            font-size: 1.3em;
            color: #1e3a8a;
            font-weight: 600;
        }

        .botoes-acao {
            display: flex;
            gap: 12px;
            margin-top: 25px;
            flex-direction: column;
        }

        .acao-btn {
            padding: 18px;
            border: none;
            border-radius: 12px;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.3s;
            font-size: 1.1em;
            min-height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        #arquivar-btn {
            background-color: #f97316;
            color: white;
        }

        #arquivar-btn:hover {
            background-color: #ea580c;
        }

        #transferir-btn {
            background-color: #8b5cf6;
            color: white;
        }

        #transferir-btn:hover {
            background-color: #7c3aed;
        }

        .historico {
            margin-top: 35px;
            padding-top: 25px;
            border-top: 2px solid #e5e7eb;
        }

        .historico h2 {
            font-size: 1.5em;
            color: #374151;
            margin-bottom: 20px;
            font-weight: 700;
        }

        .historico-lista {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .historico-item {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        .historico-data {
            font-weight: bold;
            color: #1e3a8a;
            margin-bottom: 8px;
            font-size: 1.1em;
        }

        .historico-total {
            font-weight: bold;
            color: #059669;
            margin-top: 8px;
            font-size: 1.1em;
        }

        .historico-itens {
            color: #6b7280;
            line-height: 1.5;
        }

        .sem-historico {
            text-align: center;
            color: #9ca3af;
            padding: 40px 20px;
            font-style: italic;
        }

        .loading-message {
            text-align: center;
            padding: 25px;
            color: #6b7280;
            font-size: 1.1em;
        }

        .disabled-overlay {
            opacity: 0.4;
            pointer-events: none;
            filter: blur(2px);
            transition: opacity 0.5s;
        }

        .sync-status {
            font-size: 0.8em;
            padding: 4px 8px;
            border-radius: 12px;
            margin-left: 8px;
        }

        .sync-online {
            background: #dcfce7;
            color: #166534;
        }

        .sync-offline {
            background: #fef3c7;
            color: #92400e;
        }

        @media (max-width: 380px) {
            .container {
                padding: 15px 10px;
            }

            .controles-superiores {
                flex-direction: column;
                align-items: stretch;
            }

            .modos-compra {
                justify-content: center;
            }

            .input-group {
                flex-direction: column;
            }

            .input-item-wrap {
                flex-direction: column;
            }

            #input-preco-rapida,
            #input-quantity-rapida,
            #input-preco-mercado,
            #input-quantity-mercado,
            #input-categoria-rapida,
            #input-categoria-mercado {
                min-width: 100%;
            }
        }

        button,
        .aba,
        .favorito-btn,
        .editable-price,
        .editable-quantity,
        .item-name {
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }

        button:active,
        .aba:active,
        .favorito-btn:active {
            transform: scale(0.98);
            transition: transform 0.1s;
        }

        /* Toast Notifications */
        .toast-container {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 9999;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .toast {
            padding: 14px 24px;
            border-radius: 12px;
            color: white;
            font-weight: 500;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
            animation: slideIn 0.3s ease, fadeOut 0.3s ease 2.7s;
            max-width: 90vw;
            text-align: center;
        }

        .toast-success {
            background: linear-gradient(135deg, #10b981, #059669);
        }

        .toast-error {
            background: linear-gradient(135deg, #ef4444, #dc2626);
        }

        .toast-info {
            background: linear-gradient(135deg, #3b82f6, #2563eb);
        }

        .toast-warning {
            background: linear-gradient(135deg, #f59e0b, #d97706);
        }

        @keyframes slideIn {
            from {
                transform: translateY(100px);
                opacity: 0;
            }

            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        @keyframes fadeOut {
            from {
                opacity: 1;
            }

            to {
                opacity: 0;
            }
        }

        /* Dark Mode */
        @media (prefers-color-scheme: dark) {
            body {
                background-color: #1a1a2e;
            }

            .container {
                background-color: #16213e;
                color: #e5e7eb;
            }

            h1 {
                color: #60a5fa;
            }

            .info-lista,
            .modos-compra,
            .abas-listas {
                background: #1e3a5f;
            }

            .aba {
                color: #e5e7eb;
            }

            .aba.active {
                background: #2d4a7c;
            }

            .favoritos-area {
                background: #2d3748;
                border-color: #4a5568;
            }

            .favoritos-titulo {
                color: #fbbf24;
            }

            .favorito-btn {
                background: #374151;
                border-color: #4a5568;
                color: #e5e7eb;
            }

            #input-item-rapida,
            #input-preco-rapida,
            #input-quantity-rapida,
            #input-categoria-rapida,
            #input-item-mercado,
            #input-preco-mercado,
            #input-quantity-mercado,
            #input-categoria-mercado,
            #orcamento-input,
            #sort-select-rapida,
            #sort-select-mercado {
                background: #374151;
                border-color: #4a5568;
                color: #e5e7eb;
            }

            .lista-compras li {
                border-color: #374151;
            }

            .item-name {
                color: #e5e7eb;
            }

            .editable-price,
            .editable-quantity {
                color: #e5e7eb;
            }

            .category-header {
                background-color: #1e3a5f;
                color: #e5e7eb;
            }

            .total-area {
                color: #60a5fa;
            }

            .historico {
                border-color: #374151;
            }

            .historico h2 {
                color: #e5e7eb;
            }

            .historico-item {
                background: #1e3a5f;
                border-color: #374151;
            }

            .historico-data {
                color: #60a5fa;
            }

            .historico-itens {
                color: #9ca3af;
            }

            #user-info {
                color: #9ca3af;
            }

            .alert-message {
                background-color: #1e3a5f;
                color: #60a5fa;
            }
        }

        /* Item animations */
        .lista-compras li {
            animation: fadeInUp 0.3s ease;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
    </style>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore-compat.js"></script>
</head>

<body>
    <div class="container">
        <h1>üõí Minha Lista de Compras</h1>

        <div id="auth-status">
            <div id="user-info">Conectando ao Firebase...</div>
            <div id="auth-buttons">
                <button id="google-login-btn">
                    <img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTgiIGhlaWdodD0iMTgiIHZpZXdCb3g9IjAgMCAxOCAxOCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHBhdGggZD0iTTE2LjUxIDkuMjA0NTVWOS4wOTAwOUg5LjE4VjEwLjkxSDExLjQ4QzExLjI0IDExLjk3IDEwLjUzIDEyLjkyIDkuNDcgMTMuMzZMMTEuNTYgMTUuMzlDMTMuMTQgMTMuOTMgMTQuMDIgMTEuNTMgMTQuMDIgOC45OTk5OUMxNC4wMiA4LjQyOTk5IDEzLjk2IDcuODc5OTkgMTMuODQgNy4zNDk5OUwxNi41MSA5LjIwNDU1WiIgZmlsbD0iIzQyODVGMyIvPgo8cGF0aCBkPSJNOS4xOCAxNy4wMkM2LjY2IDE3LjAyIDQuNDcgMTUuODIgMy4wNSAxMy45NEw1LjE0IDExLjkxQzUuODggMTMuMjkgNy4yMiAxNC4xIDkuMTggMTQuMUM5LjY2IDE0LjEgMTAuMTIgMTQuMDIgMTAuNTUgMTMuODdMMTIuNjQgMTUuOTBDMTEuNjMgMTYuNzMgMTAuNDggMTcuMDIgOS4xOCAxNy4wMloiIGZpbGw9IiMzNEE4NTMiLz4KPHBhdGggZD0iTTMuMDUgNi4wNTk5OUMzLjA1IDUuNjk5OTkgMy4xMSA1LjM0OTk5IDMuMjMgNC45OTk5OUwxLjE0IDIuOTY5OTlDMC41NCA0LjA0OTk5IDAuMTggNS4yNzk5OSAwLjE4IDYuNDk5OTlDMC4xOCA3LjcxOTk5IDAuNTQgOC45Mzk5OSAxLjE0IDEwLjAyTDMuMjMgNy45OTk5OUMzLjExIDcuNjQ5OTkgMy4wNSA3LjI5OTk5IDMuMDUgNi45Mzk5OVY2LjA1OTk5WiIgZmlsbD0iI0ZCQkMwNCIvPgo8cGF0aCBkPSJNOS4xOCAyLjg5OTk5QzEwLjU1IDIuODk5OTkgMTEuNzYgMy4zNjk5OSAxMi42OSA0LjI5OTk5TDE1LjA2IDEuOTI5OTlDMTMuNjMgMC41Mzk5OTQgMTEuNDggLTAuMDIwMDA2IDkuMTggLTAuMDIwMDA2QzYuNjYgLTAuMDIwMDA2IDQuNDcgMS4xNzk5OSAzLjA1IDMuMDU5OTlMNS4xNCA1LjA4OTk5QzUuODggMy43MDk5OSA3LjIyIDIuODk5OTkgOS4xOCAyLjg5OTk5WiIgZmlsbD0iIzM0QTg1MyIvPgo8L3N2Zz4K"
                        alt="Google Logo">
                    Entrar com Google
                </button>
                <button id="logout-btn" style="display:none;">Sair</button>
            </div>
            <div id="auth-error-message" class="error-message" style="display:none;"></div>
            <div id="firebase-status" class="alert-message">
                <strong>Status Firebase:</strong> Inicializando...
            </div>
        </div>

        <div id="app-content" class="loading-message disabled-overlay">
            <p id="loading-text">Fa√ßa login para aceder √† sua lista</p>

            <div class="controles-superiores">
                <div class="modos-compra">
                    <button class="modo-btn active" data-modo="rapida">‚ö° R√°pido</button>
                    <button class="modo-btn" data-modo="mercado">üè™ Mercado</button>
                </div>

                <div class="controle-orcamento">
                    <span>Or√ßamento:</span>
                    <input type="number" id="orcamento-input" placeholder="0.00" step="0.01" min="0">
                    <span id="status-orcamento" class="status-orcamento status-dentro">-</span>
                    <span id="sync-status" class="sync-status sync-offline">Offline</span>
                </div>
            </div>

            <div class="abas-listas">
                <div class="aba aba-rapida active" data-lista="rapida">üõçÔ∏è Lista R√°pida</div>
                <div class="aba aba-mercado" data-lista="mercado">üè™ Lista do Mercado</div>
            </div>

            <div id="conteudo-rapida" class="conteudo-lista active">
                <div class="info-lista">
                    <strong>Lista R√°pida:</strong> Itens do dia a dia. Adicione rapidamente e depois transfira para a
                    Lista do Mercado.
                </div>

                <div class="favoritos-area">
                    <div class="favoritos-titulo">‚≠ê Favoritos - Clique para adicionar</div>
                    <div class="lista-favoritos" id="lista-favoritos"></div>
                </div>

                <form id="form-item-rapida">
                    <div class="input-group">
                        <div class="input-item-wrap">
                            <input type="text" id="input-item-rapida" placeholder="Item (Ex: P√£o, Leite)" required
                                list="catalog-suggestions">
                        </div>
                        <input type="number" id="input-quantity-rapida" placeholder="Qtd" value="1" min="1">
                        <input type="number" id="input-preco-rapida" placeholder="Pre√ßo" step="0.01" min="0">
                        <select id="input-categoria-rapida">
                            <option value="">-- Categoria --</option>
                        </select>
                    </div>
                    <button type="submit">Adicionar √† Lista R√°pida</button>
                </form>

                <div class="sort-controls">
                    <span>Ordenar por:</span>
                    <select id="sort-select-rapida">
                        <option value="adicao">Ordem de Inclus√£o</option>
                        <option value="categoria">Categoria</option>
                    </select>
                </div>

                <ul id="lista-compras-rapida" class="lista-compras"></ul>

                <div class="total-area">
                    <strong>Total Lista R√°pida:</strong> <span id="valor-total-rapida">R$ 0,00</span>
                </div>
            </div>

            <div id="conteudo-mercado" class="conteudo-lista">
                <div class="info-lista">
                    <strong>Lista do Mercado:</strong> Compra semanal ou mensal completa. Organize por categorias e
                    controle seu or√ßamento.
                </div>

                <form id="form-item-mercado">
                    <div class="input-group">
                        <div class="input-item-wrap">
                            <input type="text" id="input-item-mercado" placeholder="Item para compra planejada" required
                                list="catalog-suggestions">
                        </div>
                        <input type="number" id="input-quantity-mercado" placeholder="Qtd" value="1" min="1">
                        <input type="number" id="input-preco-mercado" placeholder="Pre√ßo" step="0.01" min="0">
                        <select id="input-categoria-mercado">
                            <option value="">-- Categoria --</option>
                        </select>
                    </div>
                    <button type="submit">Adicionar ao Mercado</button>
                </form>

                <div class="sort-controls">
                    <span>Ordenar por:</span>
                    <select id="sort-select-mercado">
                        <option value="adicao">Ordem de Inclus√£o</option>
                        <option value="categoria">Categoria (Corredor)</option>
                    </select>
                </div>

                <ul id="lista-compras-mercado" class="lista-compras"></ul>

                <div class="total-area">
                    <strong>Total Mercado:</strong> <span id="valor-total-mercado">R$ 0,00</span>
                    <br>
                    <small id="info-orcamento" style="color: #6b7280;"></small>
                </div>
            </div>

            <datalist id="catalog-suggestions"></datalist>

            <div class="botoes-acao">
                <button id="transferir-btn" class="acao-btn">‚û°Ô∏è Transferir para Mercado</button>
                <button id="arquivar-btn" class="acao-btn">‚úÖ Finalizar Compra</button>
            </div>

            <div class="historico">
                <h2>üìä Hist√≥rico de Compras</h2>
                <div id="historico-compras" class="historico-lista">
                    <div class="sem-historico">Nenhuma compra arquivada ainda</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div id="toast-container" class="toast-container"></div>

    <script>
        // ========== CONFIGURA√á√ÉO FIREBASE ==========
        const firebaseConfig = {
            apiKey: "AIzaSyBYUgpk09FkcqLzhsKLZhi0KislYd0iqhQ",
            authDomain: "lista-de-compras-8f7db.firebaseapp.com",
            projectId: "lista-de-compras-8f7db",
            storageBucket: "lista-de-compras-8f7db.firebasestorage.app",
            messagingSenderId: "226215342595",
            appId: "1:226215342595:web:63267d7d6361d809709436"
        };

        // ========== CONFIGURA√á√ÉO DA APLICA√á√ÉO ==========
        const CATEGORIAS = [
            { id: "A01", nome: "Hortifr√∫ti / Frios" },
            { id: "A02", nome: "Latic√≠nios / Iogurtes" },
            { id: "B01", nome: "Padaria / Matinais" },
            { id: "C01", nome: "Carnes / Peixes Congelados" },
            { id: "D01", nome: "Mercearia (Arroz, Feij√£o)" },
            { id: "D02", nome: "Bebidas / Sucos" },
            { id: "E01", nome: "Limpeza" },
            { id: "E02", nome: "Higiene Pessoal" },
            { id: "Z99", nome: "Outros" }
        ];

        const FAVORITOS_PADRAO = [
            { nome: "P√£o", preco: 8.50, categoria: "B01" },
            { nome: "Leite", preco: 5.20, categoria: "A02" },
            { nome: "Ovos", preco: 15.00, categoria: "A02" },
            { nome: "Caf√©", preco: 18.90, categoria: "B01" },
            { nome: "Arroz", preco: 25.50, categoria: "D01" },
            { nome: "Feij√£o", preco: 7.80, categoria: "D01" },
            { nome: "Frango", preco: 16.50, categoria: "C01" },
            { nome: "Banana", preco: 6.50, categoria: "A01" }
        ];

        // ========== INICIALIZA√á√ÉO FIREBASE ==========
        let auth, db, userId = null;
        let isOnline = true;

        try {
            firebase.initializeApp(firebaseConfig);
            auth = firebase.auth();
            db = firebase.firestore();

            // Habilitar persist√™ncia offline
            db.enablePersistence({ synchronizeTabs: true })
                .then(() => {
                    console.log("‚úÖ Persist√™ncia offline habilitada!");
                })
                .catch((err) => {
                    if (err.code === 'failed-precondition') {
                        console.log("‚ö†Ô∏è M√∫ltiplas abas abertas, persist√™ncia desabilitada");
                    } else if (err.code === 'unimplemented') {
                        console.log("‚ö†Ô∏è Navegador n√£o suporta persist√™ncia offline");
                    }
                });

            console.log("‚úÖ Firebase inicializado com sucesso!");
            document.getElementById('firebase-status').innerHTML =
                '<strong>‚úÖ Firebase Conectado!</strong> Fa√ßa login para sincronizar seus dados.';

        } catch (error) {
            console.error("‚ùå Erro ao inicializar Firebase:", error);
            document.getElementById('firebase-status').innerHTML =
                '<strong>‚ùå Erro no Firebase:</strong> ' + error.message;
        }

        // ========== VARI√ÅVEIS GLOBAIS ==========
        let listaRapidaCache = [];
        let listaMercadoCache = [];
        let catalogData = {};
        let orcamentoAtual = 0;
        let listaAtiva = 'rapida';
        let historicoCache = [];

        // ========== FUN√á√ïES FIREBASE ==========
        async function salvarNoFirebase(colecao, dados) {
            if (!userId || !db) {
                console.log("‚ö†Ô∏è  Usu√°rio n√£o logado, salvando localmente");
                salvarDadosLocais();
                return null;
            }

            try {
                const resultado = await db.collection('users').doc(userId).collection(colecao).add({
                    ...dados,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                });
                console.log("‚úÖ Salvo no Firebase:", colecao, dados.nome);
                atualizarStatusSync(true);
                return resultado.id;
            } catch (error) {
                console.error("‚ùå Erro ao salvar no Firebase:", error);
                atualizarStatusSync(false);
                salvarDadosLocais();
                throw error;
            }
        }

        async function atualizarNoFirebase(colecao, itemId, dados) {
            if (!userId || !db) {
                salvarDadosLocais();
                return;
            }

            try {
                await db.collection('users').doc(userId).collection(colecao).doc(itemId).update(dados);
                console.log("‚úÖ Atualizado no Firebase:", colecao, itemId);
                atualizarStatusSync(true);
            } catch (error) {
                console.error("‚ùå Erro ao atualizar no Firebase:", error);
                atualizarStatusSync(false);
                salvarDadosLocais();
            }
        }

        async function removerDoFirebase(colecao, itemId) {
            if (!userId || !db) {
                salvarDadosLocais();
                return;
            }

            try {
                await db.collection('users').doc(userId).collection(colecao).doc(itemId).delete();
                console.log("‚úÖ Removido do Firebase:", colecao, itemId);
                atualizarStatusSync(true);
            } catch (error) {
                console.error("‚ùå Erro ao remover do Firebase:", error);
                atualizarStatusSync(false);
                salvarDadosLocais();
            }
        }

        // ========== FUN√á√ïES FIREBASE - HIST√ìRICO ==========
        async function salvarHistoricoFirebase(dadosCompra) {
            if (!userId || !db) {
                console.log("‚ö†Ô∏è  Usu√°rio n√£o logado, salvando hist√≥rico localmente");
                salvarHistoricoLocal(dadosCompra);
                return null;
            }

            try {
                const resultado = await db.collection('users').doc(userId).collection('historico').add({
                    ...dadosCompra,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                });
                console.log("‚úÖ Hist√≥rico salvo no Firebase:", dadosCompra.total);
                atualizarStatusSync(true);
                return resultado.id;
            } catch (error) {
                console.error("‚ùå Erro ao salvar hist√≥rico no Firebase:", error);
                atualizarStatusSync(false);
                salvarHistoricoLocal(dadosCompra);
                throw error;
            }
        }

        function setupHistoricoListener() {
            if (!userId || !db) return;

            db.collection('users').doc(userId).collection('historico')
                .orderBy('timestamp', 'desc')
                .limit(20)
                .onSnapshot((snapshot) => {
                    historicoCache = [];
                    snapshot.forEach((doc) => {
                        const data = doc.data();
                        historicoCache.push({
                            id: doc.id,
                            ...data,
                            timestamp: data.timestamp ? data.timestamp.toDate() : new Date()
                        });
                    });
                    renderHistorico();
                    atualizarStatusSync(true);
                }, (error) => {
                    console.error("‚ùå Erro listener hist√≥rico:", error);
                    atualizarStatusSync(false);
                });
        }

        // ========== FUN√á√ïES LOCAIS ==========
        function carregarDadosLocais() {
            listaRapidaCache = JSON.parse(localStorage.getItem('listaRapida')) || [];
            listaMercadoCache = JSON.parse(localStorage.getItem('listaMercado')) || [];
            catalogData = JSON.parse(localStorage.getItem('catalogo')) || {};
            orcamentoAtual = parseFloat(localStorage.getItem('orcamento')) || 0;

            document.getElementById('orcamento-input').value = orcamentoAtual;
        }

        function salvarDadosLocais() {
            localStorage.setItem('listaRapida', JSON.stringify(listaRapidaCache));
            localStorage.setItem('listaMercado', JSON.stringify(listaMercadoCache));
            localStorage.setItem('catalogo', JSON.stringify(catalogData));
            localStorage.setItem('orcamento', orcamentoAtual.toString());
        }

        function salvarHistoricoLocal(dadosCompra) {
            let historico = JSON.parse(localStorage.getItem('historicoCompras')) || [];
            historico.unshift({
                id: Date.now().toString(),
                ...dadosCompra,
                timestamp: new Date()
            });

            historico = historico.slice(0, 20);
            localStorage.setItem('historicoCompras', JSON.stringify(historico));
            historicoCache = historico;
            renderHistorico();
        }

        function carregarHistoricoLocal() {
            historicoCache = JSON.parse(localStorage.getItem('historicoCompras')) || [];
            renderHistorico();
        }

        // ========== FUN√á√ïES FIREBASE LISTENERS ==========
        function setupFirebaseListeners() {
            if (!userId || !db) return;

            // Listener para lista r√°pida
            db.collection('users').doc(userId).collection('listaRapida')
                .onSnapshot((snapshot) => {
                    listaRapidaCache = [];
                    snapshot.forEach((doc) => {
                        listaRapidaCache.push({ id: doc.id, ...doc.data() });
                    });
                    renderListaRapida();
                    atualizarStatusSync(true);
                }, (error) => {
                    console.error("‚ùå Erro listener lista r√°pida:", error);
                    atualizarStatusSync(false);
                });

            // Listener para lista mercado
            db.collection('users').doc(userId).collection('listaMercado')
                .onSnapshot((snapshot) => {
                    listaMercadoCache = [];
                    snapshot.forEach((doc) => {
                        listaMercadoCache.push({ id: doc.id, ...doc.data() });
                    });
                    renderListaMercado();
                    atualizarStatusSync(true);
                }, (error) => {
                    console.error("‚ùå Erro listener lista mercado:", error);
                    atualizarStatusSync(false);
                });

            // Configura√ß√µes
            carregarConfiguracoesFirebase();
        }

        async function carregarConfiguracoesFirebase() {
            if (!userId || !db) return;

            try {
                const catalogoDoc = await db.collection('users').doc(userId).collection('configuracoes').doc('catalogo').get();
                if (catalogoDoc.exists) {
                    catalogData = catalogoDoc.data().precos || {};
                }

                const orcamentoDoc = await db.collection('users').doc(userId).collection('configuracoes').doc('orcamento').get();
                if (orcamentoDoc.exists) {
                    orcamentoAtual = orcamentoDoc.data().valor || 0;
                    document.getElementById('orcamento-input').value = orcamentoAtual;
                }

                renderCatalogo();
                atualizarOrcamento();
                atualizarStatusSync(true);

            } catch (error) {
                console.error("‚ùå Erro ao carregar configura√ß√µes:", error);
                atualizarStatusSync(false);
            }
        }

        async function salvarConfiguracoesFirebase() {
            if (!userId || !db) return;

            try {
                await db.collection('users').doc(userId).collection('configuracoes').doc('catalogo').set({
                    precos: catalogData,
                    ultimaAtualizacao: firebase.firestore.FieldValue.serverTimestamp()
                }, { merge: true });

                await db.collection('users').doc(userId).collection('configuracoes').doc('orcamento').set({
                    valor: orcamentoAtual,
                    ultimaAtualizacao: firebase.firestore.FieldValue.serverTimestamp()
                }, { merge: true });

                console.log("‚úÖ Configura√ß√µes salvas no Firebase");
                atualizarStatusSync(true);

            } catch (error) {
                console.error("‚ùå Erro ao salvar configura√ß√µes:", error);
                atualizarStatusSync(false);
            }
        }

        function atualizarStatusSync(online) {
            isOnline = online;
            const syncStatus = document.getElementById('sync-status');
            if (online) {
                syncStatus.textContent = 'Online';
                syncStatus.className = 'sync-status sync-online';
            } else {
                syncStatus.textContent = 'Offline';
                syncStatus.className = 'sync-status sync-offline';
            }
        }

        // ========== FUN√á√ïES PRINCIPAIS ==========
        function carregarDados() {
            if (userId && db) {
                setupFirebaseListeners();
                setupHistoricoListener();
                renderFavoritos(); // Corre√ß√£o: renderizar favoritos ap√≥s login
            } else {
                carregarDadosLocais();
                carregarHistoricoLocal();
                renderListaRapida();
                renderListaMercado();
                renderFavoritos();
                renderCatalogo();
                atualizarOrcamento();
            }
        }

        function formatCurrency(value) {
            const num = parseFloat(value) || 0;
            return `R$ ${num.toFixed(2).replace('.', ',')}`;
        }

        // Toast notification system
        function showToast(message, type = 'info') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            toast.textContent = message;
            container.appendChild(toast);

            setTimeout(() => {
                toast.remove();
            }, 3000);
        }

        function detectarCategoria(nomeItem) {
            const nomeLower = nomeItem.toLowerCase();
            if (nomeLower.includes('leite') || nomeLower.includes('queijo') || nomeLower.includes('iogurte')) return 'A02';
            if (nomeLower.includes('p√£o') || nomeLower.includes('bolo') || nomeLower.includes('caf√©')) return 'B01';
            if (nomeLower.includes('arroz') || nomeLower.includes('feij√£o') || nomeLower.includes('macarr√£o')) return 'D01';
            if (nomeLower.includes('carne') || nomeLower.includes('frango') || nomeLower.includes('peixe')) return 'C01';
            if (nomeLower.includes('detergente') || nomeLower.includes('sab√£o') || nomeLower.includes('limpeza')) return 'E01';
            if (nomeLower.includes('shampoo') || nomeLower.includes('sabonete') || nomeLower.includes('papel higi√™nico')) return 'E02';
            if (nomeLower.includes('banana') || nomeLower.includes('ma√ß√£') || nomeLower.includes('laranja')) return 'A01';
            return 'Z99';
        }

        // ========== RENDERIZA√á√ÉO ==========
        function ordenarLista(lista, criterio) {
            if (criterio === 'categoria') {
                return [...lista].sort((a, b) => (a.categoria || 'Z99').localeCompare(b.categoria || 'Z99'));
            }
            return lista; // ordem de adi√ß√£o (padr√£o)
        }

        function renderListaRapida() {
            const listaUL = document.getElementById('lista-compras-rapida');
            const criterio = document.getElementById('sort-select-rapida').value;
            listaUL.innerHTML = '';

            let total = 0;
            const listaOrdenada = ordenarLista(listaRapidaCache, criterio);

            if (criterio === 'categoria') {
                let categoriaAtual = null;
                listaOrdenada.forEach(item => {
                    if (item.categoria !== categoriaAtual) {
                        categoriaAtual = item.categoria;
                        const catInfo = CATEGORIAS.find(c => c.id === categoriaAtual) || { nome: 'Outros' };
                        const header = document.createElement('li');
                        header.className = 'category-header';
                        header.textContent = catInfo.nome;
                        listaUL.appendChild(header);
                    }
                    const li = criarItemLista(item, 'rapida');
                    listaUL.appendChild(li);
                    total += (parseFloat(item.preco) || 0) * (parseInt(item.quantidade) || 1);
                });
            } else {
                listaOrdenada.forEach(item => {
                    const li = criarItemLista(item, 'rapida');
                    listaUL.appendChild(li);
                    total += (parseFloat(item.preco) || 0) * (parseInt(item.quantidade) || 1);
                });
            }

            document.getElementById('valor-total-rapida').textContent = formatCurrency(total);
        }

        function renderListaMercado() {
            const listaUL = document.getElementById('lista-compras-mercado');
            const criterio = document.getElementById('sort-select-mercado').value;
            listaUL.innerHTML = '';

            let total = 0;
            const listaOrdenada = ordenarLista(listaMercadoCache, criterio);

            if (criterio === 'categoria') {
                let categoriaAtual = null;
                listaOrdenada.forEach(item => {
                    if (item.categoria !== categoriaAtual) {
                        categoriaAtual = item.categoria;
                        const catInfo = CATEGORIAS.find(c => c.id === categoriaAtual) || { nome: 'Outros' };
                        const header = document.createElement('li');
                        header.className = 'category-header';
                        header.textContent = catInfo.nome;
                        listaUL.appendChild(header);
                    }
                    const li = criarItemLista(item, 'mercado');
                    listaUL.appendChild(li);
                    total += (parseFloat(item.preco) || 0) * (parseInt(item.quantidade) || 1);
                });
            } else {
                listaOrdenada.forEach(item => {
                    const li = criarItemLista(item, 'mercado');
                    listaUL.appendChild(li);
                    total += (parseFloat(item.preco) || 0) * (parseInt(item.quantidade) || 1);
                });
            }

            document.getElementById('valor-total-mercado').textContent = formatCurrency(total);
            atualizarOrcamento();
        }

        function criarItemLista(item, tipoLista) {
            const li = document.createElement('li');
            if (item.comprado) li.classList.add('item-comprado');

            li.innerHTML = `
                <span class="item-name">${item.nome}</span>
                <span class="editable-quantity" contenteditable="true">${item.quantidade}</span>
                <span class="editable-price" contenteditable="true">${formatCurrency(item.preco)}</span>
                <button class="remover-item">X</button>
            `;

            li.querySelector('.item-name').addEventListener('click', () => toggleComprado(item.id, tipoLista));
            li.querySelector('.remover-item').addEventListener('click', () => removerItem(item.id, tipoLista));
            li.querySelector('.editable-price').addEventListener('blur', (e) => atualizarPreco(item.id, e.target.textContent, tipoLista));
            li.querySelector('.editable-quantity').addEventListener('blur', (e) => atualizarQuantidade(item.id, e.target.textContent, tipoLista));

            return li;
        }

        function renderFavoritos() {
            const listaFavoritos = document.getElementById('lista-favoritos');
            listaFavoritos.innerHTML = '';

            FAVORITOS_PADRAO.forEach(favorito => {
                const btn = document.createElement('button');
                btn.className = 'favorito-btn';
                btn.textContent = favorito.nome;
                btn.addEventListener('click', () => adicionarFavorito(favorito));
                listaFavoritos.appendChild(btn);
            });
        }

        function renderCatalogo() {
            const datalist = document.getElementById('catalog-suggestions');
            datalist.innerHTML = '';
            Object.keys(catalogData).forEach(nome => {
                const option = document.createElement('option');
                option.value = nome;
                datalist.appendChild(option);
            });
        }

        function renderHistorico() {
            const container = document.getElementById('historico-compras');

            if (historicoCache.length === 0) {
                container.innerHTML = '<div class="sem-historico">Nenhuma compra arquivada ainda</div>';
                return;
            }

            container.innerHTML = '';

            historicoCache.forEach(compra => {
                const item = document.createElement('div');
                item.className = 'historico-item';

                const data = compra.timestamp instanceof Date ? compra.timestamp : new Date(compra.timestamp);
                const dataFormatada = data.toLocaleDateString('pt-PT', {
                    day: '2-digit',
                    month: '2-digit',
                    year: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });

                const itensTexto = compra.itens.map(item =>
                    `${item.quantidade}x ${item.nome} - ${formatCurrency(item.preco * item.quantidade)}`
                ).join('<br>');

                item.innerHTML = `
                    <div class="historico-data">üìÖ ${dataFormatada}</div>
                    <div class="historico-itens">${itensTexto}</div>
                    <div class="historico-total">Total: ${formatCurrency(compra.total)}</div>
                `;

                container.appendChild(item);
            });
        }

        // ========== FUN√á√ïES DE CRUD ==========
        async function adicionarItem(item, tipoLista) {
            const novoItem = {
                nome: item.nome,
                preco: parseFloat(item.preco) || 0,
                quantidade: parseInt(item.quantidade) || 1,
                categoria: item.categoria || detectarCategoria(item.nome),
                comprado: false
            };

            try {
                const itemId = await salvarNoFirebase(tipoLista === 'rapida' ? 'listaRapida' : 'listaMercado', novoItem);

                if (!itemId) {
                    novoItem.id = Date.now().toString();
                    novoItem.timestamp = Date.now();

                    if (tipoLista === 'rapida') {
                        listaRapidaCache.push(novoItem);
                        renderListaRapida();
                    } else {
                        listaMercadoCache.push(novoItem);
                        renderListaMercado();
                    }
                }

                catalogData[item.nome] = { preco: item.preco, categoria: novoItem.categoria };
                await salvarConfiguracoesFirebase();
                renderCatalogo();

            } catch (error) {
                console.error("Erro ao adicionar item:", error);
                novoItem.id = Date.now().toString();
                novoItem.timestamp = Date.now();

                if (tipoLista === 'rapida') {
                    listaRapidaCache.push(novoItem);
                    renderListaRapida();
                } else {
                    listaMercadoCache.push(novoItem);
                    renderListaMercado();
                }

                catalogData[item.nome] = { preco: item.preco, categoria: novoItem.categoria };
                salvarDadosLocais();
                renderCatalogo();
            }
        }

        async function toggleComprado(itemId, tipoLista) {
            const lista = tipoLista === 'rapida' ? listaRapidaCache : listaMercadoCache;
            const item = lista.find(i => i.id === itemId);
            if (item) {
                item.comprado = !item.comprado;
                await atualizarNoFirebase(
                    tipoLista === 'rapida' ? 'listaRapida' : 'listaMercado',
                    itemId,
                    { comprado: item.comprado }
                );
                tipoLista === 'rapida' ? renderListaRapida() : renderListaMercado();
            }
        }

        async function removerItem(itemId, tipoLista) {
            await removerDoFirebase(
                tipoLista === 'rapida' ? 'listaRapida' : 'listaMercado',
                itemId
            );

            if (tipoLista === 'rapida') {
                listaRapidaCache = listaRapidaCache.filter(i => i.id !== itemId);
                renderListaRapida();
            } else {
                listaMercadoCache = listaMercadoCache.filter(i => i.id !== itemId);
                renderListaMercado();
            }
        }

        async function atualizarPreco(itemId, novoPreco, tipoLista) {
            const lista = tipoLista === 'rapida' ? listaRapidaCache : listaMercadoCache;
            const item = lista.find(i => i.id === itemId);
            if (item) {
                item.preco = parseFloat(novoPreco.replace('R$', '').replace(',', '.')) || 0;
                await atualizarNoFirebase(
                    tipoLista === 'rapida' ? 'listaRapida' : 'listaMercado',
                    itemId,
                    { preco: item.preco }
                );
                tipoLista === 'rapida' ? renderListaRapida() : renderListaMercado();
            }
        }

        async function atualizarQuantidade(itemId, novaQuantidade, tipoLista) {
            const lista = tipoLista === 'rapida' ? listaRapidaCache : listaMercadoCache;
            const item = lista.find(i => i.id === itemId);
            if (item) {
                item.quantidade = parseInt(novaQuantidade) || 1;
                await atualizarNoFirebase(
                    tipoLista === 'rapida' ? 'listaRapida' : 'listaMercado',
                    itemId,
                    { quantidade: item.quantidade }
                );
                tipoLista === 'rapida' ? renderListaRapida() : renderListaMercado();
            }
        }

        function adicionarFavorito(favorito) {
            if (listaAtiva === 'rapida') {
                document.getElementById('input-item-rapida').value = favorito.nome;
                document.getElementById('input-preco-rapida').value = favorito.preco;
                document.getElementById('input-categoria-rapida').value = favorito.categoria;
                document.getElementById('input-item-rapida').focus();
            } else {
                document.getElementById('input-item-mercado').value = favorito.nome;
                document.getElementById('input-preco-mercado').value = favorito.preco;
                document.getElementById('input-categoria-mercado').value = favorito.categoria;
                document.getElementById('input-item-mercado').focus();
            }
        }

        // ========== OR√áAMENTO ==========
        function atualizarOrcamento() {
            const totalMercado = listaMercadoCache.reduce((sum, item) => {
                return sum + (parseFloat(item.preco) * parseInt(item.quantidade));
            }, 0);

            orcamentoAtual = parseFloat(document.getElementById('orcamento-input').value) || 0;

            if (userId) {
                salvarConfiguracoesFirebase();
            } else {
                localStorage.setItem('orcamento', orcamentoAtual.toString());
            }

            const statusOrcamento = document.getElementById('status-orcamento');
            const infoOrcamento = document.getElementById('info-orcamento');

            if (orcamentoAtual === 0) {
                statusOrcamento.textContent = '-';
                statusOrcamento.className = 'status-orcamento';
                if (infoOrcamento) infoOrcamento.textContent = '';
            } else {
                const percentual = (totalMercado / orcamentoAtual) * 100;

                if (percentual <= 70) {
                    statusOrcamento.textContent = `${percentual.toFixed(0)}%`;
                    statusOrcamento.className = 'status-orcamento status-dentro';
                } else if (percentual <= 90) {
                    statusOrcamento.textContent = `${percentual.toFixed(0)}%`;
                    statusOrcamento.className = 'status-orcamento status-alerta';
                } else {
                    statusOrcamento.textContent = `${percentual.toFixed(0)}%`;
                    statusOrcamento.className = 'status-orcamento status-excedido';
                }

                if (infoOrcamento) {
                    infoOrcamento.textContent = `Gasto: ${formatCurrency(totalMercado)} de ${formatCurrency(orcamentoAtual)}`;
                }
            }
        }

        // ========== TRANSFER√äNCIA E A√á√ïES ==========
        async function transferirParaMercado() {
            if (listaRapidaCache.length === 0) {
                showToast('N√£o h√° itens na Lista R√°pida para transferir!', 'warning');
                return;
            }

            let transferidos = 0;
            for (const item of listaRapidaCache) {
                if (!item.comprado) {
                    await salvarNoFirebase('listaMercado', {
                        nome: item.nome,
                        preco: item.preco,
                        quantidade: item.quantidade,
                        categoria: item.categoria,
                        comprado: false
                    });

                    await removerDoFirebase('listaRapida', item.id);
                    transferidos++;
                }
            }

            showToast(`‚úÖ ${transferidos} itens transferidos para o Mercado!`, 'success');
        }

        async function arquivarCompra() {
            const listaParaArquivar = listaAtiva === 'rapida' ? listaRapidaCache : listaMercadoCache;
            const itensComprados = listaParaArquivar.filter(item => item.comprado);

            if (itensComprados.length === 0) {
                showToast(`N√£o h√° itens comprados para arquivar!`, 'warning');
                return;
            }

            const total = itensComprados.reduce((sum, item) => {
                return sum + ((parseFloat(item.preco) || 0) * (parseInt(item.quantidade) || 1));
            }, 0);

            const dadosCompra = {
                tipo: listaAtiva === 'rapida' ? 'Lista R√°pida' : 'Lista do Mercado',
                itens: itensComprados.map(item => ({
                    nome: item.nome,
                    preco: parseFloat(item.preco) || 0,
                    quantidade: parseInt(item.quantidade) || 1,
                    categoria: item.categoria
                })),
                total: total,
                quantidadeItens: itensComprados.length
            };

            try {
                await salvarHistoricoFirebase(dadosCompra);

                for (const item of itensComprados) {
                    await removerDoFirebase(
                        listaAtiva === 'rapida' ? 'listaRapida' : 'listaMercado',
                        item.id
                    );
                }

                showToast(`‚úÖ ${itensComprados.length} itens arquivados! Total: ${formatCurrency(total)}`, 'success');

            } catch (error) {
                console.error("Erro ao arquivar compra:", error);
                showToast('‚ö†Ô∏è Compra arquivada localmente', 'warning');
            }
        }

        // ========== AUTENTICA√á√ÉO ==========
        function setupAuth() {
            const googleLoginBtn = document.getElementById('google-login-btn');
            const logoutBtn = document.getElementById('logout-btn');
            const authErrorMessageDiv = document.getElementById('auth-error-message');
            const userInfoDiv = document.getElementById('user-info');
            const appContent = document.getElementById('app-content');
            const loadingText = document.getElementById('loading-text');

            googleLoginBtn.addEventListener('click', async () => {
                try {
                    const provider = new firebase.auth.GoogleAuthProvider();
                    await auth.signInWithPopup(provider);
                } catch (error) {
                    console.error("Erro no login:", error);
                    authErrorMessageDiv.textContent = `Erro no login: ${error.message}`;
                    authErrorMessageDiv.style.display = 'block';
                }
            });

            auth.onAuthStateChanged((user) => {
                if (user) {
                    userId = user.uid;
                    userInfoDiv.innerHTML = `Logado como: <strong>${user.displayName}</strong> <button id="logout-btn">Sair</button>`;
                    googleLoginBtn.style.display = 'none';
                    authErrorMessageDiv.style.display = 'none';

                    appContent.classList.remove('disabled-overlay');
                    loadingText.style.display = 'none';

                    setTimeout(() => {
                        document.getElementById('logout-btn').addEventListener('click', () => auth.signOut());
                    }, 100);

                    carregarDados();

                } else {
                    userId = null;
                    userInfoDiv.textContent = 'Fa√ßa login para sincronizar na nuvem';
                    googleLoginBtn.style.display = 'flex';
                    logoutBtn.style.display = 'none';

                    appContent.classList.add('disabled-overlay');
                    loadingText.textContent = 'Fa√ßa login para aceder √† sua lista';
                    loadingText.style.display = 'block';

                    carregarDados();
                }
            });
        }

        // ========== EVENT LISTENERS ==========
        function setupEventListeners() {
            document.querySelectorAll('.aba').forEach(aba => {
                aba.addEventListener('click', (e) => {
                    document.querySelectorAll('.aba').forEach(a => a.classList.remove('active'));
                    document.querySelectorAll('.conteudo-lista').forEach(c => c.classList.remove('active'));

                    e.target.classList.add('active');
                    listaAtiva = e.target.dataset.lista;
                    document.getElementById(`conteudo-${listaAtiva}`).classList.add('active');
                });
            });

            document.getElementById('form-item-rapida').addEventListener('submit', (e) => {
                e.preventDefault();
                const nome = document.getElementById('input-item-rapida').value.trim();
                const preco = document.getElementById('input-preco-rapida').value;
                const quantidade = document.getElementById('input-quantity-rapida').value;
                const categoria = document.getElementById('input-categoria-rapida').value;

                if (nome) {
                    adicionarItem({ nome, preco, quantidade, categoria }, 'rapida');
                    e.target.reset();
                    document.getElementById('input-quantity-rapida').value = '1';
                }
            });

            document.getElementById('form-item-mercado').addEventListener('submit', (e) => {
                e.preventDefault();
                const nome = document.getElementById('input-item-mercado').value.trim();
                const preco = document.getElementById('input-preco-mercado').value;
                const quantidade = document.getElementById('input-quantity-mercado').value;
                const categoria = document.getElementById('input-categoria-mercado').value;

                if (nome) {
                    adicionarItem({ nome, preco, quantidade, categoria }, 'mercado');
                    e.target.reset();
                    document.getElementById('input-quantity-mercado').value = '1';
                }
            });

            document.getElementById('input-item-rapida').addEventListener('input', function () {
                const sugestao = catalogData[this.value];
                if (sugestao) {
                    document.getElementById('input-preco-rapida').value = sugestao.preco;
                    document.getElementById('input-categoria-rapida').value = sugestao.categoria;
                }
            });

            document.getElementById('input-item-mercado').addEventListener('input', function () {
                const sugestao = catalogData[this.value];
                if (sugestao) {
                    document.getElementById('input-preco-mercado').value = sugestao.preco;
                    document.getElementById('input-categoria-mercado').value = sugestao.categoria;
                }
            });

            document.getElementById('orcamento-input').addEventListener('change', atualizarOrcamento);
            document.getElementById('transferir-btn').addEventListener('click', transferirParaMercado);
            document.getElementById('arquivar-btn').addEventListener('click', arquivarCompra);

            // Event listeners para ordena√ß√£o
            document.getElementById('sort-select-rapida').addEventListener('change', renderListaRapida);
            document.getElementById('sort-select-mercado').addEventListener('change', renderListaMercado);

            // Event listeners para bot√µes de modo
            document.querySelectorAll('.modo-btn').forEach(btn => {
                btn.addEventListener('click', function () {
                    document.querySelectorAll('.modo-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    const modo = this.dataset.modo;
                    document.querySelector(`.aba[data-lista="${modo}"]`).click();
                });
            });
        }

        // ========== INICIALIZA√á√ÉO ==========
        function inicializar() {
            const selects = ['input-categoria-rapida', 'input-categoria-mercado'];
            selects.forEach(selectId => {
                const select = document.getElementById(selectId);
                select.innerHTML = '<option value="">-- Categoria --</option>';
                CATEGORIAS.forEach(cat => {
                    const option = document.createElement('option');
                    option.value = cat.id;
                    option.textContent = cat.nome;
                    select.appendChild(option);
                });
            });

            if (auth) {
                setupAuth();
            }
            setupEventListeners();

            carregarDados();

            console.log("‚úÖ Lista de Compras com Firebase e Hist√≥rico inicializada!");
        }

        document.addEventListener('DOMContentLoaded', inicializar);

        // ========== SERVICE WORKER ==========
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('sw.js')
                    .then((registration) => {
                        console.log('‚úÖ Service Worker registrado:', registration.scope);

                        // Verificar atualiza√ß√µes
                        registration.addEventListener('updatefound', () => {
                            const newWorker = registration.installing;
                            newWorker.addEventListener('statechange', () => {
                                if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                    showToast('Nova vers√£o dispon√≠vel! Recarregue a p√°gina.', 'info');
                                }
                            });
                        });
                    })
                    .catch((error) => {
                        console.log('‚ö†Ô∏è Service Worker n√£o registrado:', error);
                    });

                // Ouvir mensagens do Service Worker
                navigator.serviceWorker.addEventListener('message', (event) => {
                    if (event.data && event.data.type === 'SYNC_DATA') {
                        console.log('üì° Sincronizando dados ap√≥s voltar online...');
                        if (userId && db) {
                            carregarDados();
                            showToast('Dados sincronizados!', 'success');
                        }
                    }
                });
            });
        }

        // Detectar mudan√ßa de conex√£o
        window.addEventListener('online', () => {
            atualizarStatusSync(true);
            showToast('Conex√£o restaurada!', 'success');
            if (userId && db) {
                carregarDados();
            }
        });

        window.addEventListener('offline', () => {
            atualizarStatusSync(false);
            showToast('Voc√™ est√° offline. Os dados ser√£o sincronizados quando a conex√£o voltar.', 'warning');
        });
    </script>
</body>

</html>